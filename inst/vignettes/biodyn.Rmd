---
title: "biodyn"
author: "Laurence Kell"
date: "August 13th, 2014"
output: rmarkdown::tufte_handout
---

```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(fig.path="out/",
               echo=FALSE,
               cache=TRUE,
               cache.path="cache/",
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)

opts_knit$set(width=75)
```


```{r}
library(biodyn)
library(ggplotFL)
library(plyr)
library(diags)
```

# Introduction

\newthought{This package} implements a biodyn biomass dynamic stock assessment model. Methods are including for fitting, checking of diagnostics and goodness of fit, estimating uncertainly in stock status relative to reference points, running projections and Harvest Control Rules (HCRs) and conducting Management Strategy Evaluation (MSE).

## Equations

The Russell equation \cite{russell1931some} summarises the key processes influencing the dynamics of exploited populations where biomass $B_2$ is a function of the biomass in the previous year ($B_1$) plus gains due to growth (G) and recruitment (R) and losses due to 
fishing (F) and natural mortality (M).
 
\begin{marginfigure}
\begin{equation}f(B_2) = B_1 + (G + R) - (F+M)\end{equation}
\caption{The Russell equation}
\end{marginfigure}

Since Russel originally formulated his equation two other processes have been recognised, i.e. gains due to immigration (I) and losses due to emigration (E) thus modifying the original equation

\begin{marginfigure}
\begin{equation}f(B_2) = B_1 + (G+R+I) - (F+M+H)\end{equation}
\caption{Russell equation with migration}
\end{marginfigure}

The knowledge about these processes affects our ability to provide robust scientific advice. In a biomass dynamic stock assessment the dynamics of recruitment, growth and natural mortality are simplified into a single production function. 

\begin{marginfigure}
\begin{equation}  B_{t+1}=B_{t}-C_{t}+P_{t}\end{equation}  
\caption{Biomass dynamic}
\end{marginfigure}

$P$ can be modelled by a variety of surplus production functions e.g. Pella-Tomlinson  \citet{pella1969generalized}.

\begin{marginfigure}
\begin{equation}\frac{r}{p}\cdot~B(1-(\frac{B}{K})^p)\end{equation}  
\caption{An equation}
\end{marginfigure}

The dynamics i.e. productivity and reference points and the response of the stock to perturbations, are determined by $r$ and the shape of the production function $p$; if $p=1$ then MSY is found halfway between 0 and K, as p increases MSY shifts to the right.

\newpage

# Fitting

\newthought{Fitting to data} can be done using either maximum likelihood or by running Monte Carlo Markov Chain (MCMC) simulations.
  
For fitting we simulate a stock with know parameters and exploitation history. This makes it easier to evalaute fits. 

simBiodyn generates a stock
```{r, echo=TRUE, fig.margin=TRUE, fig.height=4, fig.cap="Simulated stock"}
bd=simBiodyn()

plot(bd)
```

The model uses a time series of catch per unit effort (CPUE) are a proxy of stock abundance, we therefore generated this from the stock biomass by taking the mid year biomass and adding an error term.

```{r, fig.margin=TRUE, fig.cap="Simulated CPUE series"}
cpue=(stock(bd)[,-dims(bd)$year]+stock(bd)[,-1])/2
cpue=rlnorm(1,log(cpue),.2)

plot(cpue)
```

Before fitting best guesses for the parameters needed to be provided as starting values and add any constraints or fix parameters. 

```{r}
setParams( bd)=cpue
params(bd)
```

The params slot will hold the fitted parameters, while the control slot takes the best initial guess, sets upper and lower bounds (min and max) and allows parameters to be fixed (i.e. setting phase=-1) or estimated sequentially (i.e. by setting phase >0, parameters will be estimated in turn based on the value of phase). 
```{r}
setControl(bd)=params(bd)

bd@control
```

To fit using maximum likelihood
```{r, fig.margin=TRUE, fig.cap="A comparison of the true and fitted time series"}
bdHat=fit(bd,cpue)

plot(biodyns("True"=bd,"Hat"=bdHat))
```

\newpage
## Diagnostics

\newthought{Goodness of fit} diagnostics are important for transparency, replicability and ensuring that a global solution has actually been found, i.e. that when the assessment is repeated that you get the same solution.

Although biomass dynamic models use only catch and effort data and only estimate a few parameters, statistical catch-at-size models with potentially 1000s of parameters are used for the same purpose i.e. to estimate population parameters from fisheries dependent data. However, similar diagnstics are requires and helps when comparing fits between stock assessment methods. 

Patterns in residuals of the fits to the CPUE and stock abundnace may indicate a violation of models assumptions. Residuals and covariates are in the diags slot.


```{r,echo=TRUE}
rsdl=bdHat@diags

head(rsdl)
```

First the observed values are plotted against the fitted values. It is assumed that an index is proportional to the stock so the points should fall around the $y=x$ line, if they do not then the index may not be a good proxy for the stock trend.

```{r-rsdl2, fig.margin=TRUE, fig.cap="Observed CPUE verses fitted, blue line is a linear resgression fitted to points, black the y=x line."}
ggplot(with(rsdl, data.frame(obs=stdz(index),hat=stdz(hat))))+
          geom_abline(aes(0,1))                         +
          geom_point( aes(obs,hat))                     +
          stat_smooth(aes(obs,hat),method="lm", se=F)    +
          theme_ms(14,legend.position="bottom")            +
          xlab("Fitted") + ylab("Observed")
```

Next the residuals are plotted agianst year along with a lowess smoother.
```{r-rsdl3,fig.height=4, fig.margin=TRUE, fig.cap="Residuals by year, with lowess smoother and SEs."}
dat=transform(subset(rsdl,!is.na(residual), residual=stdz(residual,na.rm=T)))
ggplot(aes(year,residual),data=dat)  +
  geom_hline(aes(yintercept=0))      +
  geom_point()                       +
  stat_smooth(method="loess",se=F)  +
  theme_ms(14,legend.position="bottom") 
```

It is also assumed that variance does not vary with the mean, this assumption is evaluated in where the residuals are plotted against the fitted values. 

```{r-rsdl6,fig.height=4, fig.margin=TRUE, fig.cap="Plot of residuals against fitted value, to check variance relationship."}
ggplot(aes(hat, residual),data=subset(rsdl,!is.na(hat) & !is.na(residual)))   +
  geom_hline(aes(yintercept=0))         +
  geom_point()                          +
  stat_smooth(method="loess",se=F)   +
  theme_ms(14,legend.position="bottom")
```

It is assumed that the residuals are normally distributed on the log scale and that there is no autocorrelation between them. Plots of the residuals against each other with a lag of 1 to identify autocorrelation. There are significant autocorrelations particularly for the Japanese and Taiwanese longlines, this could be due to an icrease in catchability with time. This may result in a more optimistic estimate of current stock status as any decline in the stock is masked by an increase in catchability.

```{r-rsdl4, fig.margin=TRUE, fig.cap="Plot of autocorrelation, i.e. $residual_{t+1}$ verses $residual_{t}$."}
ggplot(rsdl)                                              +
  geom_point( aes(residual,residualLag))                  +
  stat_smooth(aes(residual,residualLag),method="lm",se=F)      +
  geom_hline(aes(yintercept=0))                           +
  xlab(expression(Residual[t])) + 
  ylab(expression(Residual[t+1])) +
  theme_ms(14,legend.position="bottom")  
```

Q-Q plots compare a sample of data on the vertical axis to a statistical population on the horizontal axis, in this case a normal distribution. If the points follow a strongly nonlinear pattern this will suggest that the data are not distributed as a standard normal i.e. $X ~ N(0,1)$. Any systematic departure from a straight line may indicate skewness or over or under dispersion. For example in the panel showing the Taiwanese longline suggests that the  negative residuals are much greater in magnitude than expected.  

Violation of the assumptions about the may result in biased estimnates of estimated parameters, reference points and stock trends. In addition variance estimates obtained from bootstrapping assume that residuals are Independently and Identically Distributed (i.i.d.).

```{r-rsdl5, fig.margin=TRUE, fig.cap="Quantile-quantile plot to compare residual distribution with the normal distribution."}
ggplot(rsdl)                                           +
  geom_point( aes(qqx,qqy))                            +
  stat_smooth(aes(qqx,qqHat),method="lm",se=T,fill="blue", alpha=0.1)         +
  theme_ms(14,legend.position="bottom")               
```

\newpage
```{r,fig.height=4, fig.margin=TRUE, fig.cap="Plot predicted stock trend by index"}
ggplot(aes(year,index),data=rsdl) +
  geom_point()                                    +
  stat_smooth(method="loess",se=F)                +
  geom_line(aes(year,hat),col="black",data=rsdl) +
    scale_x_continuous(breaks=seq(0,3000,10)) +
             theme_ms(14,legend.position="bottom")
```


# Stock status

```{r}
sims=biodyns("1st Fit"=bd)
```

## Reference Points

## Uncertainty in estimates

Bootstraps
```{r,fig.height=4, fig.margin=TRUE, fig.cap="Plot predicted stock trend by index"}

```

Jack knife
```{r,fig.height=4, fig.margin=TRUE, fig.cap="Plot predicted stock trend by index"}
sims[["Jack Knife"]]=fit(bd,jackknife(cpue))

plot(sims[["Jack Knife"]])
```

```{r,fig.height=4, fig.margin=TRUE, fig.cap="Plot predicted stock trend by index"}
plotJack(sims[["Jack Knife"]],sims[["Deterministic"]])
```


Hessian
```{r,fig.height=4, fig.margin=TRUE, fig.cap="Plot predicted stock trend by index"}
sims[["MCMC"]]=fit(sims[[1]],cpue,cmdOps=c("-mcmc 1000000, -mcsave 80000"))
```

Diagnostics
```{r}
acf(c(params(sims[["MCMC"]])["r"]))
```

## variance/covariance matrix

Use the covariance matrix to conduct a Monte Carlo simulation of the parameter estimates to derive uncertainty in derived quantitries.

```{r,cache=FALSE}
sims[["Vcov"]]=mvn(sims[["Deterministic"]],500,nms=c("r","k"),fwd=TRUE)
```

Can use the covariance matrix to estimate uncertainty in other parameters, e.g. in management quantities

```{r,cache=FALSE}
sims[["Deterministic"]]@mng
```

```{r,cache=FALSE}
sims[["Deterministic"]]@mngVcov
```



## variance/covariance matrix

```{r,cache=FALSE,eval=TRUE}
currentState   =sims[["Deterministic"]]@mng[c("bbmsy","ffmsy"),"hat",drop=T]
currentStateVar=sims[["Deterministic"]]@mngVcov[c("bbmsy","ffmsy"),
                                                c("bbmsy","ffmsy"),drop=T]

mvrnorm(10,currentState,currentStateVar)

ggplot(data=as.data.frame(mvrnorm(100,currentState,currentStateVar)),
       aes(bbmsy,ffmsy))+geom_point()+
  geom_hline(aes(yintercept=1))+
  geom_vline(aes(xintercept=1))+
  xlab(expression(B:B[MSY]))+
  ylab(expression(F:F[MSY]))
```

Covariance matrix
```{r-4., fig.height=4,cache=FALSE}
sims[["Vcov"]]=mvn(bd,100,fwd=TRUE)
```

## Bootstrap CPUE and use this to simulate a new CPUE series

CPUE series
```{r-4, fig.height=4,cache=FALSE}
cpueSim=sims[[1]]@diags[,c("year","hat")]
names(cpueSim)[2]="data"
cpueSim=as.FLQuant(cpueSim)

cpueSim=rlnorm(100,log(cpueSim),0.25)
plot(cpueSim,na.rm=TRUE)

cpueSim[cpueSim==0]=NA

sims[["CPUE"]]=fit(propagate(sims[[1]],100),cpueSim)
```

Delta Method

MCMC

# Projections
```{r, fig.margin=TRUE, fig.cap=""}
harvest=rlnorm(1,log(harvest(bd))[,-dims(bd)$year],.1)
bd     =fwd(bd,harvest=harvest)

plot(bd)
```

# Stock Status


\newthought{In his later books}[^books_be], Tufte starts each section with a bit of vertical space, a non-indented paragraph, and sets the first few words of the sentence in small caps. To accomplish this using this style, use the `\newthought` command as demonstrated at the beginning of this paragraph.

# Projections


\newthought{In his later books}[^books_be], Tufte starts each section with a bit of vertical space, a non-indented paragraph, and sets the first few words of the sentence in small caps. To accomplish this using this style, use the `\newthought` command as demonstrated at the beginning of this paragraph.

# MSE

\newthought{In his later books}[^books_be], Tufte starts each section with a bit of vertical space, a non-indented paragraph, and sets the first few words of the sentence in small caps. To accomplish this using this style, use the `\newthought` command as demonstrated at the beginning of this paragraph.

# Figures


## Full Width Figures

You can arrange for figures to span across the entire page by using the `fig.fullwidth` chunk option. 

```{r, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "Full width figure"}
qplot(wt, mpg, data=mtcars, colour=factor(cyl))
```

Note the use of the `fig.width` and `fig.height` chunk options to establish the proportions of the figure. Full width figures look much better if their height is minimized.

## Main Column Figures

Besides margin and full width figures, you can of course also include figures constrained to the main column.

```{r, fig.cap = "Another figure"}
qplot(factor(cyl), mpg, data = mtcars, geom = "boxplot")
```

# Sidenotes

One of the most prominent and distinctive features of this style is the extensive use of sidenotes. There is a wide margin to provide ample room for sidenotes and small figures. Any use of a footnote will automatically be converted to a sidenote. ^[This is a sidenote that was entered using a footnote.] 

If you'd like to place ancillary information in the margin without the sidenote mark (the superscript number), you can use the `\marginnote` command. \marginnote{This is a margin note.  Notice that there isn't a number preceding the note.}

Note also that the two footnote references (`tufte_latex` and `books_be`, both defined below) were also included in the margin on the first page of this document.

# Tables

You can use the **xtable** package to format \LaTeX\ tables that integrate well with the rest of the Tufte handout style. Note that it's important to set the `xtable.comment` and `xtable.booktabs` options as shown below to ensure the table is formatted correctly for inclusion in the document.

```{r, results='asis'}
library(xtable)
options(xtable.comment = FALSE)
options(xtable.booktabs = TRUE)
xtable(head(mtcars[,1:6]), caption = "First rows of mtcars")
```


[^tufte_latex]: https://code.google.com/p/tufte-latex/
[^books_be]: http://www.edwardtufte.com/tufte/books_be










